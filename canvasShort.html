<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
	<style>
		.svg-container,
		.img_box {
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			z-index: 9999;
		}
		#clipcanvas {
			position: absolute;
			top: 0;
			left: 0;
		}
	</style>
</head>

<body>
	<div>
				<h2><a href="">asdfasdfasd</a></h2>
		 <table>
      <thead>
        <tr>
          <th>å§“å</th>
          <th>å¹´é¾„</th>
          <th>æ€§åˆ«</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>å¼ ä¸‰</td>
          <td>18</td>
          <td>ç”·</td>
        </tr>
        <tr>
          <td>æå››</td>
          <td>20</td>
          <td>ç”·</td>
        </tr>
        <tr>
          <td>ç‹äº”</td>
          <td>22</td>
          <td>ç”·</td>
        </tr>
    </table>
		<img src="https://t7.baidu.com/it/u=1819248061,230866778&fm=193&f=GIF" alt="">
	</div>
	<div id="clip-img-w" class="img_box">
		<canvas id="drawcanvas"></canvas>
	</div>
	</div>

	<script>

		/**
		 * æ ¸å¿ƒåŸç†ï¼š
		 * 1. ä½¿ç”¨html2canvaså°†body ä¿å­˜ä¸º canvas
		 * 2. å®ç°è’™å±‚å’Œè£å‰ªæ¡†ï¼ˆcanvas, svg, domï¼‰
		 * 3. æŠŠä¿å­˜ä¸‹æ¥çš„canvasç»˜åˆ¶åˆ°ä¸€ä¸ªçœŸçš„canvas(æ‰¿è½½æ•´ä¸ªbody)ä¸Š ï¼ˆdrawImageï¼‰
		 * 4. ğŸš©æ ¹æ®è£å‰ªæ¡†çš„ä½ç½®å’Œå®½é«˜ï¼Œè·å–è£å‰ªåŒºåŸŸçš„åƒç´ ä¿¡æ¯ï¼ˆgetImageDataï¼‰
		 * 5. æŠŠè£å‰ªåŒºåŸŸçš„åƒç´ ä¿¡æ¯ç»˜åˆ¶åˆ°æ–°çš„canvas(æœ€åè¾“å‡ºçš„æˆªå›¾)ä¸Šï¼ˆputImageDataï¼‰
		 * 6. å°†æ–°çš„canvasè½¬ä¸ºbase64 ï¼ˆtoDataURLï¼‰
		*/


		let screenShortImage = null;
		const drawcanvasCtx = drawcanvas.getContext('2d');

		window.onload = () => {
			// ä¸èƒ½ä½¿ç”¨100% è£å‰ªæ¡†åç§»
			drawcanvas.width = window.innerWidth;
			drawcanvas.height = window.innerHeight;
			html2canvas(document.body, {
				allowTaint: true, 
				useCORS: true,
				scale: 1, 
				width: window.innerWidth,
				height: window.innerHeight,
				scrollX: window.scrollX,
				scrollY: -window.scrollY,
				windowWidth: window.innerWidth,
				windowHeight: window.innerHeight,
				x: 0,
				y: 0,
				// foreignObjectRendering: true,
			}).then(canvas => {
				screenShortImage = canvas;
				drawMask();
			});
		}


		const drawMask = () => {
			drawcanvasCtx.clearRect(0, 0, drawcanvas.width, drawcanvas.height);
			drawcanvasCtx.save();
			drawcanvasCtx.fillStyle = 'rgba(0,0,0,0.5)';
			drawcanvasCtx.fillRect(0, 0, drawcanvas.width, drawcanvas.height);
			drawcanvasCtx.restore();
		}
		// å®šä¹‰ç”¨äºå­˜å‚¨é¼ æ ‡ä½ç½®çš„å˜é‡
    var isDrawing = false; // æ ‡å¿—é¼ æ ‡æ˜¯å¦æŒ‰ä¸‹
    var startX, startY; // èµ·å§‹ä½ç½®
    var endX, endY; // ç»“æŸä½ç½®
		var cutWidth, cutHeight; // è£å‰ªå®½é«˜

    // ç›‘å¬é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
   function mouseDownHandler (e) {
      isDrawing = true;
      startX = e.clientX;
      startY = e.clientY;
    };

    // ç›‘å¬é¼ æ ‡ç§»åŠ¨äº‹ä»¶
		function mouseMoveHandler(e) {
      if (!isDrawing) return;
			
      endX = e.clientX;
      endY = e.clientY;
			cutWidth = endX - startX;
			cutHeight = endY - startY;
			drawMask();
      // ç»˜åˆ¶çŸ©å½¢

			// drawcanvasCtx.globalCompositeOperation = "source-atop"; // é‡å éƒ¨åˆ†æ˜¾ç¤ºä¸Šå±‚
      drawcanvasCtx.clearRect(startX, startY, cutWidth, cutHeight);
    
			//  // ä½¿ç”¨drawImageå°†å›¾ç‰‡ç»˜åˆ¶åˆ°è’™å±‚ä¸‹æ–¹
			// drawcanvasCtx.save();
			// drawcanvasCtx.globalCompositeOperation = "destination-over";
			// console.log(screenShortImage)
			// drawcanvasCtx.drawImage(
			// 	screenShortImage,
			// 	0,
			// 	0,
			// 	drawcanvas.width,
			// 	drawcanvas.height
			// );
			// drawcanvasCtx.restore();

		};

    // ç›‘å¬é¼ æ ‡é‡Šæ”¾äº‹ä»¶
    function mouseUpHandler() {
      isDrawing = false;
			let base64 = saveCanvasToBase64();

			const img = document.createElement('img');
			img.src = base64;
			document.body.appendChild(img);
    };

		drawcanvas.addEventListener('mousedown', mouseDownHandler);
		drawcanvas.addEventListener('mousemove', mouseMoveHandler);
		drawcanvas.addEventListener('mouseup', mouseUpHandler);

		function saveCanvasToBase64() {
			const dpr = window.devicePixelRatio || 1;
			drawcanvasCtx.globalCompositeOperation = "destination-over"; // é‡å éƒ¨åˆ†æ˜¾ç¤ºä¸Šå±‚

			// æŠŠä¿å­˜çš„body canvasç»˜åˆ¶åˆ°è’™å±‚ä¸‹æ–¹
			drawcanvasCtx.drawImage(
				screenShortImage,
				0,
				0,
				drawcanvas.width,
				drawcanvas.height
			);
			drawcanvasCtx.restore();

			// è·å–è£å‰ªåŒºåŸŸçš„åƒç´ ä¿¡æ¯
			const img = drawcanvasCtx.getImageData(
				startX,
				startY,
				cutWidth,
				cutHeight
			);
			const canvas = document.createElement('canvas');
			canvas.width = cutWidth;
			canvas.height = cutHeight;
			const imgCtx = canvas.getContext("2d")

			// æŠŠè£å‰ªåŒºåŸŸçš„åƒç´ ä¿¡æ¯ç»˜åˆ¶åˆ°æ–°çš„canvasä¸Š
			imgCtx.putImageData(img, 0, 0);

			const base64 = canvas.toDataURL('png');
			return base64;
		}
	</script>

</body>

</html>